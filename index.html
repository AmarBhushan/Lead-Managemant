<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeniusHub CRM Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .active-filter { border-width: 2px !important; transform: scale(1.05); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .loader { border-top-color: #4f46e5; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .timeline-line { position: absolute; left: 15px; top: 8px; bottom: 0; width: 2px; background: #e5e7eb; z-index: 0; }
        .timeline-item { position: relative; z-index: 1; padding-left: 36px; }
        .timeline-dot { position: absolute; left: 11px; top: 6px; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 1px #e5e7eb;}
    </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-24">

    <!-- Header -->
    <header class="fixed top-0 w-full bg-white shadow-sm z-40 px-4 py-3 flex justify-between items-center">
        <div>
            <h1 class="font-bold text-indigo-700 leading-tight">GeniusHub <span class="text-gray-900">CRM</span></h1>
            <p id="currentViewLabel" class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">All Leads</p>
        </div>
        
        <div class="flex items-center space-x-3">
            <button onclick="toggleView('followups')" id="followupBtn" class="relative text-gray-500 hover:text-indigo-600 transition-colors p-2 bg-gray-100 rounded-lg">
                <i class="fas fa-calendar-check"></i>
                <span id="followupBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[9px] font-bold px-1 rounded-full border-2 border-white">0</span>
            </button>
            <button onclick="openSettingsModal()" class="text-gray-500 hover:text-indigo-600 transition-colors p-2 bg-gray-100 rounded-lg">
                <i class="fas fa-sliders-h"></i>
            </button>
        </div>
    </header>

    <!-- Filter Bar (Stats) -->
    <div class="mt-16 px-4 mb-2 flex space-x-2 overflow-x-auto no-scrollbar py-2">
        <button onclick="setStatusFilter('All')" id="stat-All" class="flex-shrink-0 bg-white border border-gray-200 px-4 py-2 rounded-xl text-xs font-bold transition-all active-filter">
            All <span id="countAll" class="ml-1 text-gray-400">0</span>
        </button>
        <div id="statusStatsList" class="flex space-x-2">
            <!-- Dynamic Status Buttons -->
        </div>
    </div>

    <!-- Date Filters -->
    <div class="px-4 mb-4 grid grid-cols-2 gap-2">
        <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400 uppercase">From</span>
            <input type="date" id="filterFrom" onchange="renderUI()" class="w-full bg-white border border-gray-200 rounded-lg pl-12 pr-2 py-2 text-xs focus:ring-1 focus:ring-indigo-500 outline-none">
        </div>
        <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-400 uppercase">To</span>
            <input type="date" id="filterTo" onchange="renderUI()" class="w-full bg-white border border-gray-200 rounded-lg pl-10 pr-2 py-2 text-xs focus:ring-1 focus:ring-indigo-500 outline-none">
        </div>
    </div>

    <!-- Main Content -->
    <main id="loadingState" class="flex flex-col items-center justify-center mt-20">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-10 w-10 mb-3"></div>
        <p class="text-gray-400 text-sm font-medium">Syncing pipeline...</p>
    </main>

    <div id="enquiryList" class="px-4 space-y-3 hidden"></div>

    <div id="emptyState" class="hidden flex flex-col items-center justify-center mt-32 text-gray-400 px-10 text-center">
        <i class="fas fa-filter text-5xl mb-4 text-gray-200"></i>
        <p class="font-semibold text-gray-500">No leads found</p>
        <p class="text-xs mt-1">Try changing filters or add a new lead to start your pipeline.</p>
    </div>

    <!-- FAB -->
    <button onclick="openNewModal()" class="fixed bottom-6 right-6 bg-indigo-600 text-white w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-2xl active:scale-95 transition-transform z-30">
        <i class="fas fa-plus"></i>
    </button>

    <!-- NEW LEAD MODAL -->
    <div id="newModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-[500px] rounded-t-3xl sm:rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">New Lead</h2>
                <button onclick="closeModal('newModal')" class="bg-gray-100 w-8 h-8 rounded-full"><i class="fas fa-times text-gray-500 text-sm"></i></button>
            </div>
            <form id="enquiryForm" onsubmit="handleSaveLead(event)" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Lead Name</label>
                        <input type="text" id="newName" required class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white outline-none" placeholder="Student or Parent Name">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Phone</label>
                        <input type="tel" id="newPhone" class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white outline-none" placeholder="+1...">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Country</label>
                        <input type="text" id="newCountry" class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white outline-none" placeholder="USA, UK...">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Initial Stage</label>
                        <select id="newStatus" class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl outline-none"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Source</label>
                        <input type="text" id="newSource" class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white outline-none" placeholder="Instagram, Ads...">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Initial Note</label>
                    <textarea id="newNotes" rows="2" class="w-full mt-1 p-3 bg-gray-50 border border-gray-200 rounded-xl focus:bg-white outline-none" placeholder="How did they find us? Requirements?"></textarea>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition-all">Create Lead</button>
            </form>
        </div>
    </div>

    <!-- DETAILS & FOLLOWUP MODAL -->
    <div id="detailsModal" class="fixed inset-0 bg-black/60 z-50 hidden flex flex-col justify-end sm:items-center sm:justify-center">
        <div class="bg-white w-full sm:w-[600px] rounded-t-3xl sm:rounded-2xl flex flex-col max-h-[92vh]">
            <div class="p-5 border-b flex justify-between items-start">
                <div>
                    <h2 id="detailName" class="text-xl font-bold">Name</h2>
                    <div class="flex items-center space-x-2 mt-1 text-sm text-gray-500">
                        <span id="detailLocSource">Location â€¢ Source</span>
                    </div>
                </div>
                <button onclick="closeModal('detailsModal')" class="bg-gray-100 w-8 h-8 rounded-full"><i class="fas fa-times text-gray-500"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-5">
                <!-- Update Stage / Followup -->
                <div class="bg-indigo-50/50 p-4 rounded-2xl border border-indigo-100 mb-6">
                    <h3 class="text-xs font-bold text-indigo-700 uppercase mb-3">Update Progress</h3>
                    <form onsubmit="handleUpdateLead(event)" class="space-y-4">
                        <input type="hidden" id="updateId">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">New Stage</label>
                                <select id="updateStatus" class="w-full mt-1 p-2.5 bg-white border border-gray-200 rounded-lg text-sm font-semibold"></select>
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Set Follow-up</label>
                                <input type="datetime-local" id="updateFollowup" class="w-full mt-1 p-2 bg-white border border-gray-200 rounded-lg text-sm">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Add Remark</label>
                            <textarea id="updateNote" rows="2" class="w-full mt-1 p-2.5 bg-white border border-gray-200 rounded-lg text-sm" placeholder="What happened in the latest talk?"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white py-2.5 rounded-lg font-bold text-sm shadow hover:bg-indigo-700">Save Update</button>
                    </form>
                </div>

                <!-- History -->
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 ml-1">Activity Log</h3>
                <div id="timelineContainer" class="relative bg-white p-4 rounded-2xl border border-gray-100"></div>

                <div class="mt-8 pt-4 border-t text-center">
                    <button onclick="handleDeleteLead()" class="text-red-500 text-xs font-bold px-4 py-2 bg-red-50 rounded-lg hover:bg-red-100">
                        <i class="fas fa-trash-alt mr-1"></i> Delete Lead Permanently
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center">
        <div class="bg-white w-full sm:w-[450px] rounded-t-3xl sm:rounded-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">Pipeline Settings</h2>
                <button onclick="closeModal('settingsModal')" class="bg-gray-100 w-8 h-8 rounded-full"><i class="fas fa-times text-gray-500"></i></button>
            </div>
            
            <section class="mb-8">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Manage Stages</h3>
                <div id="stagesManagerList" class="space-y-3 mb-4">
                    <!-- List of current stages with delete buttons -->
                </div>
                <div class="bg-gray-50 p-4 rounded-xl border border-dashed border-gray-300">
                    <p class="text-[10px] font-bold text-gray-400 uppercase mb-2">Add New Stage</p>
                    <div class="flex space-x-2">
                        <input type="text" id="newStageName" class="flex-1 p-2 border border-gray-200 rounded-lg text-sm" placeholder="Stage Name">
                        <input type="color" id="newStageColor" class="w-10 h-10 border-none bg-transparent cursor-pointer" value="#6366f1">
                        <button onclick="handleAddStage()" class="bg-indigo-600 text-white px-4 rounded-lg"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </section>

            <section class="border-t pt-6">
                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Data Management</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="handleExport()" class="flex flex-col items-center justify-center p-4 bg-blue-50 text-blue-700 rounded-2xl border border-blue-100 font-bold hover:bg-blue-100">
                        <i class="fas fa-download text-xl mb-2"></i>
                        <span class="text-xs">Export JSON</span>
                    </button>
                    <button onclick="document.getElementById('importFile').click()" class="flex flex-col items-center justify-center p-4 bg-green-50 text-green-700 rounded-2xl border border-green-100 font-bold hover:bg-green-100">
                        <i class="fas fa-upload text-xl mb-2"></i>
                        <span class="text-xs">Import JSON</span>
                    </button>
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="handleImport(event)">
                </div>
            </section>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'geniushub-crm-v2';

        // State
        let user = null;
        let leads = [];
        let stages = [
            { id: 'cold', label: 'â„ï¸ Cold', color: '#94a3b8' },
            { id: 'hot', label: 'ðŸ”¥ Hot', color: '#f97316' },
            { id: 'demo', label: 'ðŸ“… Demo Booked', color: '#8b5cf6' },
            { id: 'done', label: 'âœ… Admission Done', color: '#22c55e' },
            { id: 'dropped', label: 'âŒ Dropped', color: '#ef4444' }
        ];
        let currentStatusFilter = 'All';
        let currentView = 'pipeline'; // 'pipeline' or 'followups'

        // Auth Init
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        }

        // --- Core UI Logic ---

        window.renderUI = () => {
            const container = document.getElementById('enquiryList');
            const empty = document.getElementById('emptyState');
            const followBadge = document.getElementById('followupBadge');
            
            // 1. Get Today's Follow-ups
            const today = new Date().toISOString().split('T')[0];
            const tasksToday = leads.filter(l => l.followupDate && l.followupDate.startsWith(today));
            followBadge.innerText = tasksToday.length;
            followBadge.classList.toggle('hidden', tasksToday.length === 0);

            // 2. Render Status Stats Bar
            const statsList = document.getElementById('statusStatsList');
            statsList.innerHTML = stages.map(s => {
                const count = leads.filter(l => l.statusId === s.id).length;
                const isActive = currentStatusFilter === s.id;
                return `
                    <button onclick="setStatusFilter('${s.id}')" id="stat-${s.id}" class="flex-shrink-0 bg-white border border-gray-200 px-4 py-2 rounded-xl text-xs font-bold transition-all ${isActive ? 'active-filter' : ''}">
                        <span style="color: ${s.color}">${s.label}</span> <span class="ml-1 text-gray-400">${count}</span>
                    </button>
                `;
            }).join('');
            document.getElementById('countAll').innerText = leads.length;
            document.getElementById('stat-All').classList.toggle('active-filter', currentStatusFilter === 'All');

            // 3. Filtering Logic
            let filtered = [...leads];
            
            // Filter by View
            if (currentView === 'followups') {
                filtered = tasksToday;
                document.getElementById('currentViewLabel').innerText = "Today's Follow-ups";
            } else {
                document.getElementById('currentViewLabel').innerText = currentStatusFilter === 'All' ? "All Leads" : `Filtering: ${stages.find(s => s.id === currentStatusFilter)?.label}`;
                // Filter by Status
                if (currentStatusFilter !== 'All') {
                    filtered = filtered.filter(l => l.statusId === currentStatusFilter);
                }
            }

            // Filter by Date Range
            const fromDate = document.getElementById('filterFrom').value;
            const toDate = document.getElementById('filterTo').value;
            if (fromDate) filtered = filtered.filter(l => new Date(l.createdAt) >= new Date(fromDate));
            if (toDate) filtered = filtered.filter(l => new Date(l.createdAt) <= new Date(toDate + "T23:59:59"));

            // Sort by latest activity
            filtered.sort((a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt));

            container.innerHTML = '';
            if (filtered.length === 0) {
                container.classList.add('hidden');
                empty.classList.remove('hidden');
                return;
            }

            empty.classList.add('hidden');
            container.classList.remove('hidden');

            filtered.forEach(lead => {
                const stage = stages.find(s => s.id === lead.statusId) || stages[0];
                const lastHistory = lead.history?.[lead.history.length - 1]?.note || "No recent activity recorded.";
                const isUrgent = lead.followupDate && lead.followupDate.startsWith(today);

                container.innerHTML += `
                    <div onclick="openDetails('${lead.id}')" class="bg-white p-4 rounded-2xl shadow-sm border ${isUrgent ? 'border-indigo-300 ring-1 ring-indigo-100' : 'border-gray-100'} cursor-pointer active:scale-[0.98] transition-all">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-gray-900">${lead.name}</h3>
                                <div class="flex items-center space-x-2 text-[10px] text-gray-500 uppercase font-bold tracking-tight mt-1">
                                    <span>${lead.country || 'Global'}</span>
                                    <span>â€¢</span>
                                    <span>${lead.source || 'Direct'}</span>
                                </div>
                            </div>
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold border" style="background-color: ${stage.color}15; color: ${stage.color}; border-color: ${stage.color}40">
                                ${stage.label}
                            </span>
                        </div>
                        
                        <div class="bg-gray-50 p-2.5 rounded-lg text-xs text-gray-600 italic line-clamp-1 mb-3">
                            "${lastHistory}"
                        </div>

                        <div class="flex justify-between items-center text-[10px] font-bold">
                            <div class="flex items-center space-x-2">
                                ${lead.followupDate ? `
                                    <span class="${isUrgent ? 'text-indigo-600' : 'text-gray-400'}">
                                        <i class="far fa-clock mr-1"></i> Follow-up: ${new Date(lead.followupDate).toLocaleString([], {month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'})}
                                    </span>` : '<span class="text-gray-300">No follow-up set</span>'}
                            </div>
                            <span class="text-gray-400">${new Date(lead.createdAt).toLocaleDateString()}</span>
                        </div>
                    </div>
                `;
            });
        };

        // --- Interaction Handlers ---

        window.setStatusFilter = (statusId) => {
            currentStatusFilter = statusId;
            currentView = 'pipeline';
            window.renderUI();
        };

        window.toggleView = (view) => {
            currentView = currentView === view ? 'pipeline' : view;
            window.renderUI();
        };

        window.openNewModal = () => {
            document.getElementById('enquiryForm').reset();
            const select = document.getElementById('newStatus');
            select.innerHTML = stages.map(s => `<option value="${s.id}">${s.label}</option>`).join('');
            document.getElementById('newModal').classList.remove('hidden');
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        window.handleSaveLead = async (e) => {
            e.preventDefault();
            if (!user) return;
            const btn = e.submitter;
            btn.disabled = true;
            btn.innerText = "Creating...";

            const now = Date.now();
            const data = {
                name: document.getElementById('newName').value,
                phone: document.getElementById('newPhone').value,
                country: document.getElementById('newCountry').value,
                source: document.getElementById('newSource').value,
                statusId: document.getElementById('newStatus').value,
                createdAt: now,
                updatedAt: now,
                history: [{
                    timestamp: now,
                    action: 'Lead Created',
                    note: document.getElementById('newNotes').value || 'Fresh entry.',
                    statusId: document.getElementById('newStatus').value
                }]
            };

            try {
                const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'leads');
                await addDoc(colRef, data);
                window.closeModal('newModal');
            } catch (err) {
                console.error(err);
            } finally {
                btn.disabled = false;
                btn.innerText = "Create Lead";
            }
        };

        window.openDetails = (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;

            document.getElementById('updateId').value = id;
            document.getElementById('detailName').innerText = lead.name;
            document.getElementById('detailLocSource').innerText = `${lead.country || 'No Location'} â€¢ ${lead.source || 'Direct'}`;
            
            // Setup Update Form
            const statusSelect = document.getElementById('updateStatus');
            statusSelect.innerHTML = stages.map(s => `<option value="${s.id}" ${s.id === lead.statusId ? 'selected' : ''}>${s.label}</option>`).join('');
            document.getElementById('updateFollowup').value = lead.followupDate || '';
            document.getElementById('updateNote').value = '';

            // Render Timeline
            const tl = document.getElementById('timelineContainer');
            if (!lead.history || lead.history.length === 0) {
                tl.innerHTML = '<p class="text-xs text-gray-400 italic">No history available.</p>';
            } else {
                const hist = [...lead.history].sort((a, b) => b.timestamp - a.timestamp);
                tl.innerHTML = '<div class="timeline-line"></div>' + hist.map(h => {
                    const s = stages.find(st => st.id === h.statusId) || { label: 'Unknown', color: '#ccc' };
                    return `
                        <div class="timeline-item mb-5">
                            <div class="timeline-dot" style="background-color: ${s.color}"></div>
                            <div class="text-[10px] font-bold text-gray-400 mb-1">${new Date(h.timestamp).toLocaleString()}</div>
                            <div class="flex items-center text-sm font-bold">
                                ${h.action} <span class="ml-2 px-1.5 py-0.5 rounded text-[9px] uppercase" style="background: ${s.color}20; color: ${s.color}">${s.label}</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">${h.note || ''}</p>
                        </div>
                    `;
                }).join('');
            }

            document.getElementById('detailsModal').classList.remove('hidden');
        };

        window.handleUpdateLead = async (e) => {
            e.preventDefault();
            const id = document.getElementById('updateId').value;
            const lead = leads.find(l => l.id === id);
            if (!lead || !user) return;

            const newStatus = document.getElementById('updateStatus').value;
            const newFollowup = document.getElementById('updateFollowup').value;
            const newNote = document.getElementById('updateNote').value;
            const now = Date.now();

            const historyItem = {
                timestamp: now,
                action: newStatus === lead.statusId ? 'Note Added' : 'Stage Changed',
                statusId: newStatus,
                note: newNote || (newStatus !== lead.statusId ? `Moved to ${stages.find(s=>s.id===newStatus)?.label}` : 'Update')
            };

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id);
                await updateDoc(docRef, {
                    statusId: newStatus,
                    followupDate: newFollowup,
                    updatedAt: now,
                    history: [...(lead.history || []), historyItem]
                });
                window.closeModal('detailsModal');
            } catch (err) {
                console.error(err);
            }
        };

        window.handleDeleteLead = async () => {
            const id = document.getElementById('updateId').value;
            if (!id || !confirm("Are you sure? This delete is permanent.")) return;
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id);
                await deleteDoc(docRef);
                window.closeModal('detailsModal');
            } catch (err) {
                console.error(err);
            }
        };

        // --- Settings / Stages Management ---

        window.openSettingsModal = () => {
            const list = document.getElementById('stagesManagerList');
            list.innerHTML = stages.map(s => `
                <div class="flex items-center justify-between bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                    <div class="flex items-center space-x-3">
                        <div class="w-4 h-4 rounded-full" style="background-color: ${s.color}"></div>
                        <span class="text-sm font-bold">${s.label}</span>
                    </div>
                    <button onclick="handleDeleteStage('${s.id}')" class="text-gray-300 hover:text-red-500 transition-colors"><i class="fas fa-trash-alt text-xs"></i></button>
                </div>
            `).join('');
            document.getElementById('settingsModal').classList.remove('hidden');
        };

        window.handleAddStage = async () => {
            const name = document.getElementById('newStageName').value.trim();
            const color = document.getElementById('newStageColor').value;
            if (!name) return;

            const newStage = { id: name.toLowerCase().replace(/\s/g, '_'), label: name, color: color };
            const updatedStages = [...stages, newStage];
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pipeline');
                await setDoc(docRef, { stages: updatedStages });
                document.getElementById('newStageName').value = '';
                window.openSettingsModal(); // Refresh list
            } catch (err) {
                console.error(err);
            }
        };

        window.handleDeleteStage = async (sid) => {
            if (stages.length <= 1) return alert("You must have at least one stage.");
            const updatedStages = stages.filter(s => s.id !== sid);
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pipeline');
                await setDoc(docRef, { stages: updatedStages });
                window.openSettingsModal();
            } catch (err) {
                console.error(err);
            }
        };

        // --- Sync Data ---

        const startSync = () => {
            if (!user) return;

            // Sync Settings (Stages)
            onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pipeline'), (snap) => {
                if (snap.exists()) {
                    stages = snap.data().stages;
                    window.renderUI();
                }
            }, (err) => console.error(err));

            // Sync Leads
            const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'leads');
            onSnapshot(colRef, (snap) => {
                leads = [];
                snap.forEach(d => leads.push({ id: d.id, ...d.data() }));
                document.getElementById('loadingState').classList.add('hidden');
                window.renderUI();
            }, (err) => console.error(err));
        };

        // --- Backup / Restore ---
        
        window.handleExport = () => {
            const data = { leads, stages, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `GeniusHub_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.handleImport = async (event) => {
            const file = event.target.files[0];
            if (!file || !confirm("This will merge imported leads into your current database. Proceed?")) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (imported.stages) {
                        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pipeline'), { stages: imported.stages });
                    }
                    if (imported.leads) {
                        const colRef = collection(db, 'artifacts', appId, 'users', user.uid, 'leads');
                        for (const l of imported.leads) {
                            const { id, ...cleanLead } = l;
                            await addDoc(colRef, cleanLead);
                        }
                    }
                    alert("Import successful!");
                    window.closeModal('settingsModal');
                } catch (err) {
                    alert("Import failed: Check file format.");
                }
            };
            reader.readAsText(file);
        };

        // Startup
        (async () => {
            try {
                await initAuth();
                onAuthStateChanged(auth, (u) => {
                    user = u;
                    if (user) startSync();
                });
            } catch (e) {
                console.error("Auth initialization failed", e);
            }
        })();
    </script>
</body>
</html>
